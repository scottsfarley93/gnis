<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Show drawn polygon area</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.54.0/mapbox-gl.js"></script>
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.54.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <style>
      .calculation-box {
        height: 250px;
        width: 250px;
        position: absolute;
        bottom: 0px;
        left: 0px;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 15px;
        text-align: center;
      }

      p {
        font-family: "Open Sans";
        margin: 0;
        font-size: 13px;
      }
    </style>

<script src="https://cdn.jsdelivr.net/npm/@turf/turf@5/turf.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.js"></script>
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.css"
      type="text/css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>
    <link href="https://api.mapbox.com/mapbox-assembly/v0.23.2/assembly.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/themes/red/pace-theme-loading-bar.min.css" rel='stylesheet' />
    <div id='loading' class='h-full w-full bg-red'>
        Please wait... 
    </div>
    <div id="map"></div>
    <div class="calculation-box">
      <p class='txt py12'>Draw a polygon to select features</p>
      <div id="extracted-features" class='py12'><p><strong>0</strong></p> Features Selected</div>
      <button class='btn btn-l my24' id="download-features">Download Features</button>
    </div>

    <script>
    let IS_LOADING = true;
    let EXTRACTED_FEATURES = {type:'FeatureCollection', features: []};
    function main(){
        getData()   
            .then((data)=>{
                console.log("app is open for business")
                IS_LOADING = false;
                map.on('draw.create', (evt)=>{
                    handleExtraction(data);
                });
                map.on('draw.delete', (evt)=>{
                    handleExtraction(data);
                });
                map.on('draw.update', (evt)=>{
                    handleExtraction(data);
                });
                document.getElementById("download-features").addEventListener("click", ()=>{
                    handleDownload();
                })

            })
            .catch((err)=>{
                throw new Error("Failed to load data: " + err);
            })
    }



    main();

      mapboxgl.accessToken =
        "pk.eyJ1Ijoic2NvdHRzZmFybGV5OTMiLCJhIjoiY2o4ODJxNjh4MWVndjJ3cWI5ODRlZ2hnayJ9.w9-dF3jh-GtQzk9h0wBUbw";
      var map = new mapboxgl.Map({
        container: "map", // container id
        style: "mapbox://styles/mapbox/satellite-streets-v9", //hosted style id
        center: [-91.874, 42.76], // starting position
        zoom: 4 // starting zoom
      });

      map.on('load', ()=>{
        map.addSource('gnis', {type:'geojson', data: {type:'FeatureCollection', features: []}});
        map.addLayer({id:'gnis', type:'circle', source: 'gnis', paint: {'circle-color': 'red', 'circle-radius': 3}})
      })


      var draw = new MapboxDraw({
        displayControlsDefault: false,
        controls: {
          polygon: true,
          trash: true
        }
      });
      map.addControl(draw);

      function getData(){
        return new Promise((resolve, reject)=>{
            const location = "./natural_features_2.csv";
            fetch(location)
                .then((resp)=>{
                    return resp.text();
                })
                .then((data)=>{
                    const geojson = toGeojson(data);
                    const featureSet = {type:'FeatureCollection', features: geojson};
                    return resolve(featureSet);
                })
                .catch((err)=>{
                    return reject(err);
                })
        })
      }

      function toGeojson(pdt){
        let data = pdt.split("\n").map((line)=>{
        try{
          const featureData = line.split(',')
            return {
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [parseFloat(featureData[4]), parseFloat(featureData[3])]
                },
                properties: {
                    featureName: featureData[0].replace(/(\r\n|\n|\r)/gm, ""),
                    state: featureData[2].replace(/(\r\n|\n|\r)/gm, ""),
                    category: featureData[1].replace(/(\r\n|\n|\r)/gm, ""),
                    map: featureData[5].replace(/(\r\n|\n|\r)/gm, "")
                }
            }
            }catch(err){
                return
            }
  
        });
        data = data.filter((ft)=>{
            return ft && !isNaN(ft.geometry.coordinates[0]) && !isNaN(ft.geometry.coordinates[1])
        })
        return data;
      }

      function extractFeatures(data, bbox){
        const within = turf.pointsWithinPolygon(data, bbox);
        return within;
      }

      function displayWithin(extractedFeatures){
        document.getElementById("extracted-features").innerHTML = "<p><strong>" + extractedFeatures.features.length + "</strong> features selected</p>";
        map.getSource('gnis').setData(extractedFeatures)
      }

      function handleExtraction(data){
        const extractedFeatures = extractFeatures(data, draw.getAll());
        displayWithin(extractedFeatures);
        EXTRACTED_FEATURES = extractedFeatures;
      }

      function handleDownload(){
        downloadCSV(EXTRACTED_FEATURES);
      }

      function toCSV(data){
          let csvOut = "featureName,category,state,map,longitude,latitude\n"
          data.features.forEach((feature)=>{

              csvOut += `${feature.properties.featureName},${feature.properties.category},${feature.properties.state},${feature.properties.map},${feature.geometry.coordinates[0]},${feature.geometry.coordinates[1]}\n`;
          });
          return csvOut;
      }

      function downloadCSV( data) {  
        var csv = toCSV(data);
        if (csv == null) return;

        filename = 'export.csv';
        let element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(csv));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);

    }
    </script>
  </body>
</html>
